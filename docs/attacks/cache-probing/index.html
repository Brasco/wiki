<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The principle of Cache Probing consists of detecting whether some resource was cached by the browser. The concept is known since the begging of the web 1 and initially used timing differences to succeed.
When a user visits a website some resources such as images, scripts and HTML content are fetched and later cached by the browser (under certain conditions). This optimization will make future navigations faster as the browser will serve those resources from disk instead of requesting them again."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Cache Probing"><meta property="og:description" content="The principle of Cache Probing consists of detecting whether some resource was cached by the browser. The concept is known since the begging of the web 1 and initially used timing differences to succeed.
When a user visits a website some resources such as images, scripts and HTML content are fetched and later cached by the browser (under certain conditions). This optimization will make future navigations faster as the browser will serve those resources from disk instead of requesting them again."><meta property="og:type" content="article"><meta property="og:url" content="https://xsleaks.com/docs/attacks/cache-probing/"><meta property="article:modified_time" content="2020-09-27T11:05:39+02:00"><title>Cache Probing | XS-Leaks Wiki</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.3fdda1dce1e2459a1b1fc70c3e00001cd6e4d2f1f32f38ddef6e12ca41e9cef6.css integrity="sha256-P92h3OHiRZobH8cMPgAAHNbk0vHzLzjd724SykHpzvY="><script defer src=/en.search.min.55bbe51b7c566d76276792047f4ea0e56d93dbbc0aefdca33c3791dc096ab941.js integrity="sha256-VbvlG3xWbXYnZ5IEf06g5W2T27wK79yjPDeR3AlquUE="></script><script defer src=/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js integrity="sha256-dKi7B/C+6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>XS-Leaks Wiki</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><a href=/docs/attacks/>Attacks</a><ul><li><a href=/docs/attacks/experiments/>Experiments</a><ul><li><a href=/docs/attacks/experiments/scroll-to-text-fragment/>Scroll to Text Fragment</a></li></ul></li><li><a href=/docs/attacks/historical/ class=collapsed>Historical</a></li><li><a href=/docs/attacks/timing-attacks/>Timing Attacks</a><ul><li><a href=/docs/attacks/timing-attacks/clocks/>Clocks</a></li><li><a href=/docs/attacks/timing-attacks/connection-pool/>Connection Pool</a></li><li><a href=/docs/attacks/timing-attacks/execution-timing/>Execution Timing</a></li><li><a href=/docs/attacks/timing-attacks/hybrid-timing/>Hybrid Timing</a></li><li><a href=/docs/attacks/timing-attacks/network-timing/>Network Timing</a></li></ul></li><li><a href=/docs/attacks/corb/>CORB Leaks</a></li><li><a href=/docs/attacks/corp/>CORP Leaks</a></li><li><a href=/docs/attacks/error-events/>Error Events</a></li><li><a href=/docs/attacks/frame-counting/>Frame Counting</a></li><li><a href=/docs/attacks/id-attribute/>ID Attribute</a></li><li><a href=/docs/attacks/navigations/>Navigations</a></li><li><a href=/docs/attacks/postmessage-broadcasts/>postMessage Broadcasts</a></li><li><a href=/docs/attacks/xs-search/>XS-Search</a></li><li><a href=/docs/attacks/cache-probing/ class=active>Cache Probing</a></li></ul></li><li class=book-section-flat><a href=/docs/defenses/>Defense Mechanisms</a><ul><li><span>Application Design</span><ul><li><a href=/docs/defenses/design-protections/subresource-protections/>Subresource Protections</a></li></ul></li><li><span>Browser Default</span><ul><li><a href=/docs/defenses/browser-intrinsic/corb/>Cross-Origin Read Blocking</a></li><li><a href=/docs/defenses/browser-intrinsic/partitioned-cache/>Partitioned HTTP Cache</a></li></ul></li><li><span>Opt-In</span><ul><li><a href=/docs/defenses/opt-in/coop/>Cross-Origin-Opener-Policy</a></li><li><a href=/docs/defenses/opt-in/corp/>Cross-Origin-Resource-Policy</a></li><li><a href=/docs/defenses/opt-in/fetch-metadata/>Fetch Metadata</a></li><li><a href=/docs/defenses/opt-in/xfo/>Framing Protections</a></li><li><a href=/docs/defenses/opt-in/same-site-cookies/>Same-Site Cookies</a></li></ul></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Cache Probing</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#attack-principle>Attack Principle</a></li><li><a href=#cache-probing-with-error-events>Cache Probing with Error Events</a><ul><li><a href=#invalidate-the-cache>Invalidate the cache</a></li></ul></li><li><a href=#defense>Defense</a><ul><li><a href=#opt-in-defense-mechanisms>Opt-in Defense Mechanisms</a></li><li><a href=#default-defense-mechanisms>Default Defense Mechanisms</a></li></ul></li><li><a href=#real-world-example>Real World Example</a></li><li><a href=#references>References</a></li></ul></nav></aside></header><article class=markdown><h1>Cache Probing</h1><div>Attacks
<a href=/attacks/dom-property/>dom property</a></div><div>Category
<a href=/category/attacks/>attacks</a></div><div>Defenses
<a href=/defenses/same-site-cookies/>same-site cookies</a>,
<a href=/defenses/sec-fetch-metadata/>sec-fetch metadata</a></div><p><p>The principle of Cache Probing consists of detecting whether some resource was cached by the browser. The concept is known since the begging of the web <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> and initially used timing differences to succeed.</p><p>When a user visits a website some resources such as images, scripts and HTML content are fetched and later cached by the browser (under certain conditions). This optimization will make future navigations faster as the browser will serve those resources from disk instead of requesting them again. If an attacker can detect which
resources are cached it may be enough to leak whether a user accessed a specific page in the past.</p><p>A variation of the original concept abused <a href=https://TODO-REFFERSUBSECTIONBELLOW>Error Events</a> to perform more accurate and impactful attacks, including tricks to invalidate resources from the cache (to make better inferences).</p><h2 id=attack-principle>Attack Principle
<a class=anchor href=#attack-principle>#</a></h2><p>An attacker wants to know whether a user visited a certain social network.</p><ol><li>A user visits a social network and some of the subresources will be cached. This step might not happen depending on the user behavior.</li><li>The user visits an attacker-controlled page which will fetch a resource that is usually fetched by that social network.</li><li>Using a <a href=https://TODO>Network Timing XS-Leak</a>, the attacker page can detect the difference from a response coming from the cache (step 1 happened) or coming from the network (step 1 did not happen). The delay will be significantly lower in a request served from the cache.</li></ol><h2 id=cache-probing-with-error-events>Cache Probing with Error Events
<a class=anchor href=#cache-probing-with-error-events>#</a></h2><p>Cache Probing with <a href=https://TODO-REFFERSUBSECTIONBELLOW>Error Events</a> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> allows more accurate and impactful attacks. Instead of relying on timing measurements, they leverage <a href=https://TODO-REFFERSUBSECTIONBELLOW>Error Events</a> and some server behaviors to detect whether a resource was cached. It also uses a trick to invalidate resources from the cache. The attack works as follows:</p><ol><li><a href=#invalidate-the-cache>Invalidate the resource</a> from the browser cache. This step is required to make sure the attack will not consider a resource previously cached in another visit.</li><li>Perform a request to load subresources of the target website. This can be done by navigating to the target website with <code>&lt;link rel=prerender..</code>, embedding the website in an <code>iframe</code> or opening a new window with <code>window.open</code>.</li><li>Perform a request with an <a href=https://lists.archive.carbon60.com/apache/users/316239>overlong referrer</a> which will usually make the server fail when receiving the request. If the resource was cached in step 2, this request will succeed instead.</li></ol><h3 id=invalidate-the-cache>Invalidate the cache
<a class=anchor href=#invalidate-the-cache>#</a></h3><p>To invalidate a resource from the cache the attacker must force the server to return an error when fetching that subresource. There are a couple of ways to achieve this:</p><ul><li>A request with an <a href=https://lists.archive.carbon60.com/apache/users/316239>overlong referrer</a> and <code>'cache':'reload'</code>. This might not work as browsers <a href=%28https://github.com/whatwg/fetch/issues/903%29>capped</a> the length of the referrer to prevent this.</li><li>A <code>POST</code> request with a <code>fetch</code> <code>no-cors</code>. Sometimes even in cases where an error is not returned the browser invalidates the cache.</li><li>Request Headers such as Content-Type, Accept, Accept-Language, etc that may cause the server to fail (more application dependent).</li><li>Other request properties.</li></ul><p>Often some of these alternatives might be considered a <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=959789#c9">browser bug</a>.</p><h2 id=defense>Defense
<a class=anchor href=#defense>#</a></h2><h3 id=opt-in-defense-mechanisms>Opt-in Defense Mechanisms
<a class=anchor href=#opt-in-defense-mechanisms>#</a></h3><table><thead><tr><th style=text-align:center><a href=https://TODO>Same-Site Cookies</a></th><th style=text-align:center><a href=https://xsleaks.com/docs/defenses/opt-in/fetch-metadata/#fetch-metadata--cache-probing-attacks>Vary: Sec-Fetch-Site</a></th><th style=text-align:center><a href=https://xsleaks.com/docs/defenses/design-protections/subresource-protections/>Subresource Protections</a></th></tr></thead><tbody><tr><td style=text-align:center>✔️ (if strict)</td><td style=text-align:center>✔️</td><td style=text-align:center>✔️ & ❌ <a href=https://TODO-referdeploysectioninsubresourceprotection>*</a></td></tr></tbody></table><ul><li>If a resource can be fetched with user authentication, <a href=https://TODO>Same-Site Cookies</a> (Strict) should be considered to protect that resource from being abused by an attacker origin.</li><li><a href=https://xsleaks.com/docs/defenses/opt-in/fetch-metadata/#fetch-metadata--cache-probing-attacks>Vary: Sec-Fetch-Site</a> allows applications to force cache segregation by a group of origins.</li><li><a href=https://xsleaks.com/docs/defenses/design-protections/subresource-protections/>Subresource Protections</a> allow application to set random tokens in URLs to make them unpredictable from attackers. Useful for both authenticated and unauthenticated subresources.</li></ul><h3 id=default-defense-mechanisms>Default Defense Mechanisms
<a class=anchor href=#default-defense-mechanisms>#</a></h3><p><a href=https://TODO>Paritioned Caches</a>, a feature implemented in browsers to create a unique cache for each origin. This protection prevents an attacker origin to interfere with cached resources of other origins. Applications do not have to opt-in to enforce this.</p><blockquote class="book-hint warning">Partitioned Caches are not available in most browsers by default, so applications cannot rely on them as of September 2020.</blockquote><h2 id=real-world-example>Real World Example
<a class=anchor href=#real-world-example>#</a></h2><ol><li>An attacker using the <a href=https://TODO>Error Events Cache Probing</a> could detect wether a user watched a specific YouTube Video by checking if the video thumbnail ended up in browser cache <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</li></ol><h2 id=references>References
<a class=anchor href=#references>#</a></h2><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>Timing Attacks on Web Privacy, <a href=http://www.cs.jhu.edu/~fabian/courses/CS600.424/course_papers/webtiming.pdf>link</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>HTTP Cache Cross-Site Leaks, <a href=http://sirdarckcat.blogspot.com/2019/03/http-cache-cross-site-leaks.html>link</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>Mass XS-Search using Cache Attack, <a href=https://terjanq.github.io/Bug-Bounty/Google/cache-attack-06jd2d2mz2r0/index.html#VIII-YouTube-watching-history>link</a> <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/xsleaks/wiki/commit/595c9d55fb9a9926714b835d1971a02906ef2f74 title="Last modified by Roberto Clapis | September 27, 2020" target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>Last Modified: September 27, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/xsleaks/wiki/edit/master/content//docs/attacks/cache-probing.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this article</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#attack-principle>Attack Principle</a></li><li><a href=#cache-probing-with-error-events>Cache Probing with Error Events</a><ul><li><a href=#invalidate-the-cache>Invalidate the cache</a></li></ul></li><li><a href=#defense>Defense</a><ul><li><a href=#opt-in-defense-mechanisms>Opt-in Defense Mechanisms</a></li><li><a href=#default-defense-mechanisms>Default Defense Mechanisms</a></li></ul></li><li><a href=#real-world-example>Real World Example</a></li><li><a href=#references>References</a></li></ul></nav></aside></main></body></html>