<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Measuring the time of JavaScript execution in a browser can give attackers information on when certain events are triggered, and how long some operations take.
Timing the Event Loop #  JavaScript&rsquo;s concurrency model is based on a single-threaded event loop which means it can only run one task at a time. If, for example, some time-consuming task blocks the event loop, the user can perceive a freeze on a page as a result of the UI thread being starved."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Execution Timing"><meta property="og:description" content="Measuring the time of JavaScript execution in a browser can give attackers information on when certain events are triggered, and how long some operations take.
Timing the Event Loop #  JavaScript&rsquo;s concurrency model is based on a single-threaded event loop which means it can only run one task at a time. If, for example, some time-consuming task blocks the event loop, the user can perceive a freeze on a page as a result of the UI thread being starved."><meta property="og:type" content="article"><meta property="og:url" content="https://xsleaks.dev/docs/attacks/timing-attacks/execution-timing/"><meta property="article:published_time" content="2020-10-01T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-04T22:53:42+01:00"><title>Execution Timing | XS-Leaks Wiki</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.62d4a8cadd84fac6902eda1a0d09fc02098feb2b5faa4fd18c9862eb3c0b03a4.css integrity="sha256-YtSoyt2E+saQLtoaDQn8AgmP6ytfqk/RjJhi6zwLA6Q="><script defer src=/en.search.min.a21c553ea443ae134e7eb7ef95a19f1729ac4d084e02917fd65cbb95cdb92ff8.js integrity="sha256-ohxVPqRDrhNOfrfvlaGfFymsTQhOApF/1ly7lc25L/g="></script><script defer src=/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js integrity="sha256-dKi7B/C+6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>XS-Leaks Wiki</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Attacks</span><ul><li><a href=/docs/attacks/xs-search/>XS-Search</a></li><li><a href=/docs/attacks/error-events/>Error Events</a></li><li><a href=/docs/attacks/frame-counting/>Frame Counting</a></li><li><a href=/docs/attacks/navigations/>Navigations</a></li><li><a href=/docs/attacks/cache-probing/>Cache Probing</a></li><li><a href=/docs/attacks/id-attribute/>ID Attribute</a></li><li><a href=/docs/attacks/postmessage-broadcasts/>postMessage Broadcasts</a></li><li><span>Browser Features</span><ul><li><a href=/docs/attacks/browser-features/corb/>CORB Leaks</a></li><li><a href=/docs/attacks/browser-features/corp/>CORP Leaks</a></li></ul></li><li><span>Timing Attacks</span><ul><li><a href=/docs/attacks/timing-attacks/clocks/>Clocks</a></li><li><a href=/docs/attacks/timing-attacks/network-timing/>Network Timing</a></li><li><a href=/docs/attacks/timing-attacks/execution-timing/ class=active>Execution Timing</a></li><li><a href=/docs/attacks/timing-attacks/hybrid-timing/>Hybrid Timing</a></li><li><a href=/docs/attacks/timing-attacks/connection-pool/>Connection Pool</a></li></ul></li><li><a href=/docs/attacks/experiments/ class=collapsed>Experiments</a></li><li><a href=/docs/attacks/historical/ class=collapsed>Historical</a></li></ul></li><li class=book-section-flat><a href=/docs/defenses/>Defense Mechanisms</a><ul><li><a href=/docs/defenses/design-protections/>Application Design</a><ul><li><a href=/docs/defenses/design-protections/cache-protections/>Cache Protections</a></li><li><a href=/docs/defenses/design-protections/subresource-protections/>Subresource Protections</a></li></ul></li><li><a href=/docs/defenses/opt-in/>Opt-In Mechanisms</a><ul><li><a href=/docs/defenses/opt-in/fetch-metadata/>Fetch Metadata</a></li><li><a href=/docs/defenses/opt-in/coop/>Cross-Origin-Opener-Policy</a></li><li><a href=/docs/defenses/opt-in/corp/>Cross-Origin-Resource-Policy</a></li><li><a href=/docs/defenses/opt-in/xfo/>Framing Protections</a></li><li><a href=/docs/defenses/opt-in/same-site-cookies/>SameSite Cookies</a></li></ul></li><li><a href=/docs/defenses/isolation-policies/>Isolation Policies</a><ul><li><a href=/docs/defenses/isolation-policies/resource-isolation/>Resource Isolation Policy</a></li><li><a href=/docs/defenses/isolation-policies/framing-isolation/>Framing Isolation Policy</a></li><li><a href=/docs/defenses/isolation-policies/navigation-isolation/>Navigation Isolation Policy</a></li><li><a href=/docs/defenses/isolation-policies/strict-isolation/>Strict Isolation Policy</a></li></ul></li><li><a href=/docs/defenses/secure-defaults/>Secure Defaults</a><ul><li><a href=/docs/defenses/secure-defaults/corb/>Cross-Origin Read Blocking</a></li><li><a href=/docs/defenses/secure-defaults/partitioned-cache/>Partitioned HTTP Cache</a></li></ul></li></ul></li><li class=book-section-flat><a href=/docs/contributions/>Contributions</a><ul></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Execution Timing</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#timing-the-event-loop>Timing the Event Loop</a></li><li><a href=#busy-event-loop>Busy Event Loop</a></li><li><a href=#service-workers>Service Workers</a></li><li><a href=#css-injections>CSS Injections</a><ul><li><a href=#jquery-css-selectors--short-circuit-timing>jQuery, CSS Selectors & Short-circuit Timing</a></li></ul></li><li><a href=#redos>ReDoS</a></li><li><a href=#defense>Defense</a></li><li><a href=#references>References</a></li></ul></nav></aside></header><article class=markdown><h1>Execution Timing</h1><h5>October 1, 2020</h5><div>Abuse
<a href=/abuse/event-loop/>Event Loop</a>,
<a href=/abuse/service-workers/>Service Workers</a>,
<a href=/abuse/site-isolation/>Site Isolation</a>,
<a href=/abuse/css-injections/>CSS Injections</a>,
<a href=/abuse/regex-injections/>Regex Injections</a>,
<a href=/abuse/iframes/>iframes</a></div><div>Category
<a href=/category/attack/>Attack</a></div><div>Defenses
<a href=/defenses/fetch-metadata/>Fetch Metadata</a>,
<a href=/defenses/samesite-cookies/>SameSite Cookies</a>,
<a href=/defenses/coop/>COOP</a>,
<a href=/defenses/framing-protections/>Framing Protections</a></div><p><p>Measuring the time of JavaScript execution in a browser can give attackers information on when certain events are triggered, and how long some operations take.</p><h2 id=timing-the-event-loop>Timing the Event Loop
<a class=anchor href=#timing-the-event-loop>#</a></h2><p>JavaScript&rsquo;s concurrency model is based on a <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop>single-threaded event loop</a> which means it can only run one task at a time. If, for example, some time-consuming task blocks the event loop, the user can perceive a freeze on a page as a result of the UI thread being starved. Other tasks must wait until the blocking one runs to conclusion. Each browser implements different <a href=https://www.chromium.org/developers/design-documents/process-models>process models</a>, which means some web sites might run in different threads (and event loops) depending on their relations.</p><p>Some techniques can exploit this model to steal secrets from a cross-origin page:</p><ul><li>Infer how long code from a different origin takes to run by measuring how long it takes to run next in the event pool <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. The attacker keeps sending events to the event loop with fixed properties, which will eventually be dispatched if the pool is empty. Other origins will dispatch events to the same pool, and this is where an attacker infers the timing difference by detecting if a delay occurred with one of its tasks.</li><li>Steal a secret from a cross-origin page if the said secret is being compared by an attacker-controlled string. The leak is a result of comparing timing differences in the event loop of a char-by-char string comparison <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> (using the previous technique). In browsers without <a href=https://www.chromium.org/Home/chromium-security/site-isolation>process isolation</a>, cross-window communications between different origins will run in the same thread, thus sharing the same event loop.</li></ul><blockquote class="book-hint2 important"><p class="hint-title important"><svg class="book-icon"><use href="/svg/hint-icons.svg#important-notice"/></svg><span>important</span></p>This attack is no longer possible in Browsers with process isolation mechanisms in place. Such mechanisms are only present in Chromium-Based browsers with <a href=https://www.chromium.org/Home/chromium-security/site-isolation>Site Isolation</a> and <em>soon</em> in Firefox under <a href=https://wiki.mozilla.org/Project_Fission>Project Fission</a>.</blockquote><h2 id=busy-event-loop>Busy Event Loop
<a class=anchor href=#busy-event-loop>#</a></h2><p>Another technique to measure JavaScript Execution consists of blocking the event loop of a thread and timing how long it takes for the event loop to become available again. One of the main advantages of this technique is its ability to circumvent Site Isolation as an attacker origin can mess with the execution of another origin. The attack works as follows:</p><ol><li>Navigate the target website in a separate window with <code>window.open</code> or inside an <code>iframe</code> (if <a href=https://xsleaks.dev/docs/defenses/opt-in/xfo/>Framing Protections</a> are not in place).</li><li>Wait for the long computation to start.</li><li>Load any same-site page inside an <code>iframe</code>, regardless of any <a href=https://xsleaks.dev/docs/defenses/opt-in/xfo/>Framing Protections</a>.</li></ol><p>An attacker can detect how long the target website is executed by timing how long it took for the <code>iframe</code> (in step 3) to trigger the <code>onload</code> event (<a href=https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/>Network Timing</a> of step 3 should be minimal). Since both navigations occurred within the same context and they are same-site, they run in the same thread and share the same event loop (they can block each other).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#6272a4>// Open a new window to measure how long the window blocks the event loop
</span><span style=color:#6272a4>// for the site example.org
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>window</span>.open(<span style=color:#f1fa8c>&#39;https://example.org/expensive&#39;</span>);

<span style=color:#6272a4>// TODO: Wait for the expensive window to load, e.g. via timeout
</span><span style=color:#6272a4>// then create an iframe to the same site
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>var</span> ifr <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>document</span>.createElement(<span style=color:#f1fa8c>&#39;iframe&#39;</span>);
ifr.src <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;https://example.org&#34;</span>;
<span style=color:#8be9fd;font-style:italic>document</span>.body.appendChild(ifr);

<span style=color:#6272a4>// Measure the initial time
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>var</span> start <span style=color:#ff79c6>=</span> performance.now();

ifr.onload <span style=color:#ff79c6>=</span> () =&gt; {
    <span style=color:#6272a4>// When the iframe loads calculate the time difference
</span><span style=color:#6272a4></span>    <span style=color:#8be9fd;font-style:italic>var</span> time <span style=color:#ff79c6>=</span> performance.now() <span style=color:#ff79c6>-</span> start;
    console.log(<span style=color:#f1fa8c>&#39;It took %d ms to load the window&#39;</span>, time);
}
</code></pre></div><h2 id=service-workers>Service Workers
<a class=anchor href=#service-workers>#</a></h2><p><a href=https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API>Service Workers</a> can be used to offer offline solutions to web applications but they can be abused by attackers to measure the timing of javascript execution<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. They serve as a proxy between the browser and the network and allow applications to intercept any network requests made by the main thread (document).</p><p>To make a timing measurement an attacker can perform the following steps:</p><ol><li>The attacker registers a service worker in one of its domains (attacker.com).</li><li>In the main document, the attacker issues a navigation (window.open) to the target website and instructs the Service Worker to start a timer.</li><li>When the new window starts loading the attacker will navigate the reference obtained in step 2 to a page handled by the service worker.</li><li>When the request performed in step 3 arrives to the Service Worker it will return a 204 (No Content) response, which will abort the navigation.</li><li>At this point the Service Worker will collect a measurement from the timer started in step 2. This measurement will be affected by how long JavaScript blocked the navigation for.</li></ol><p>Since no navigation actually occurs, steps from 3 to 5 can be repeated to get more measurements on successive JavaScript execution timings.</p><h2 id=css-injections>CSS Injections
<a class=anchor href=#css-injections>#</a></h2><blockquote class="book-hint2 warning"><p class="hint-title warning"><svg class="book-icon"><use href="/svg/hint-icons.svg#warning-notice"/></svg><span>warning</span></p>This group of XS-Leaks requires a CSS Injection on the target page.</blockquote><p>Among the different CSS Injection vectors, the most noticeable one is the abuse of CSS Selectors. They can be used as an expression to match and select certain HTML elements. For example, the selector <code>input[value^="a"]</code> will be matched if the value of an <code>input</code> tag starts with the character &ldquo;a&rdquo;. So, to detect if a CSS Selector matched the expression, attackers could trigger a callback to one of their websites using certain properties like <code>background</code>, <code>@import</code>, etc <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>. The matching process can be easily brute-forced, and extended to the full string.</p><h3 id=jquery-css-selectors--short-circuit-timing>jQuery, CSS Selectors & Short-circuit Timing
<a class=anchor href=#jquery-css-selectors--short-circuit-timing>#</a></h3><p>Attackers can abuse another interesting behavior of CSS selectors which is <code>short-circuit</code> evaluation of expressions. This expression is received in an <code>URL</code> hash and evaluated if the page executes <code>jQuery(location.hash)</code> <sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>.</p><p>A timing attack is possible because the expression is compared from right to left, so if the selector <code>main[id='site-main']</code> does not match and fails to evaluate, the other parts of the selector (<code>*:has(*:has(*:has(*))))</code>) which take longer to execute, are ignored (just like the <code>and</code> operator but backwards).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>$(<span style=color:#f1fa8c>&#34;*:has(*:has(*:has(*)) *:has(*:has(*:has(*))) *:has(*:has(*:has(*)))) main[id=&#39;site-main&#39;]&#34;</span>)
</code></pre></div><blockquote class="book-hint2 tip"><p class="hint-title tip"><svg class="book-icon"><use href="/svg/hint-icons.svg#tip-notice"/></svg><span>tip</span></p>In browsers with process isolation mechanisms, <a href=https://xsleaks.dev/docs/attacks/timing-attacks/execution-timing/#service-workers>Service Workers</a> can be abused to obtain the execution timing measurement or tricks like <a href=#busy-event-loop>Busy Event Loop tricks</a> to circumvent Site Isolation.</blockquote><h2 id=redos>ReDoS
<a class=anchor href=#redos>#</a></h2><blockquote class="book-hint2 warning"><p class="hint-title warning"><svg class="book-icon"><use href="/svg/hint-icons.svg#warning-notice"/></svg><span>warning</span></p>This group of XS-Leaks requires an injection of Regex Expressions on the target page.</blockquote><p>Regular Expression Denial of Service (ReDoS) is a technique which results in a Denial of Service in applications that allow Regex as user input <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> <sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>. Maliciously crafted regular expressions can be made to run in exponential time. This can be used as an XS-Leak vector if a regex can be injected that has a different runtime depending on some data on the page. This could happen on the client-side or the server-side.</p><h2 id=defense>Defense
<a class=anchor href=#defense>#</a></h2><table><thead><tr><th style=text-align:center>Attack Alternative</th><th style=text-align:center><a href=https://xsleaks.dev/docs/defenses/opt-in/same-site-cookies/>SameSite Cookies (Lax)</a></th><th style=text-align:center><a href=https://xsleaks.dev/docs/defenses/opt-in/coop/>COOP</a></th><th style=text-align:center><a href=https://xsleaks.dev/docs/defenses/opt-in/xfo/>Framing Protections</a></th><th style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/>Isolation Policies</a></th></tr></thead><tbody><tr><td style=text-align:center>T. Event Loop</td><td style=text-align:center>❌</td><td style=text-align:center>❓</td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr><tr><td style=text-align:center>Service Workers</td><td style=text-align:center>✔️</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr><tr><td style=text-align:center>jQuery</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr><tr><td style=text-align:center>ReDoS</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr><tr><td style=text-align:center>Busy Event Loop</td><td style=text-align:center>✔️</td><td style=text-align:center>✔️</td><td style=text-align:center>❌</td><td style=text-align:center><a href=https://xsleaks.dev/docs/defenses/isolation-policies/navigation-isolation/>NIP</a></td></tr></tbody></table><h2 id=references>References
<a class=anchor href=#references>#</a></h2><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>Loophole: Timing Attacks on Shared Event Loops in Chrome, <a href=https://www.usenix.org/system/files/conference/usenixsecurity17/sec17-vila.pdf>link</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>Matryoshka - Web Application Timing Attacks (or.. Timing Attacks against JavaScript Applications in Browsers), <a href=https://sirdarckcat.blogspot.com/2014/05/matryoshka-web-application-timing.html>link</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>Security: XS-Search + XSS Auditor = Not Cool, <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=922829">link</a> <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>CSS Injection Primitives, <a href=https://x-c3ll.github.io/posts/CSS-Injection-Primitives/>link</a> <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><p>HTTPLeaks, <a href=https://github.com/cure53/HTTPLeaks/>link</a> <a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6 role=doc-endnote><p>A timing attack with CSS selectors and Javascript, <a href=https://blog.sheddow.xyz/css-timing-attack/>link</a> <a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7 role=doc-endnote><p>A Rough Idea of Blind Regular Expression Injection Attack, <a href=https://diary.shift-js.info/blind-regular-expression-injection/>link</a> <a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/xsleaks/wiki/commit/998e70126aa3fd797b4b20d1683a1e1b3796049f title="Last modified by terjanq | December 4, 2020" target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>Last Modified: December 4, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/xsleaks/wiki/edit/master/content//docs/attacks/timing-attacks/execution-timing.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this article</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#timing-the-event-loop>Timing the Event Loop</a></li><li><a href=#busy-event-loop>Busy Event Loop</a></li><li><a href=#service-workers>Service Workers</a></li><li><a href=#css-injections>CSS Injections</a><ul><li><a href=#jquery-css-selectors--short-circuit-timing>jQuery, CSS Selectors & Short-circuit Timing</a></li></ul></li><li><a href=#redos>ReDoS</a></li><li><a href=#defense>Defense</a></li><li><a href=#references>References</a></li></ul></nav></aside></main></body></html>